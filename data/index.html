<html>
<head>
  <title>Noditron</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, width=device-width" />

	<link rel="stylesheet" type="text/css" href="litegraph.css">
  <script src="https://unpkg.com/react@latest/umd/react.development.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@latest/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@mui/material@latest/umd/material-ui.development.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/babel-standalone@latest/babel.min.js" crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

	<script type="text/javascript" src="math.js"></script>
	<script type="module" src="websocket.js"></script>
	<script type="module" src="litegraph.js"></script>

</head>

<body style='width:100%; height:100%'>
	
	<canvas id='mycanvas' width='100%' height='100%'></canvas>
  <div id="root">React is loading...</div>

  <script type = "module">
      
    window.nodes = {list: {Math: ["add", "counter"], Logic: ["and", "or"], Route: ["select", "split"]}}
    window.nodes.addNode = (name) => {
      name = name.toLowerCase();
      console.log(name)
      window.graph.beforeChange();
      var node = LiteGraph.createNode(name);
      if (node) {
        node.setPos((window.canvas.visible_area[0] + window.canvas.visible_area[2]) / 2,
              (window.canvas.visible_area[1] + window.canvas.visible_area[3]) / 2);
              window.graph.add(node, false);
      }

      window.graph.afterChange();
    }
    window.nodes.remNode = () => {
        var graph = window.graph;
          graph.beforeChange();

          var fApplyMultiNode = function (node) {
              if (node.removable === false) {
                  return;
              }
              graph.remove(node);
          };

          var graphcanvas = LGraphCanvas.active_canvas;
              for (var i in graphcanvas.selected_nodes) {
                  fApplyMultiNode(graphcanvas.selected_nodes[i]);
              }

          graph.afterChange();
      if (graphcanvas.selected_nodes && graphcanvas.selected_nodes[0]) {
            graphcanvas.selected_nodes[0].setDirtyCanvas(true, true);
      }
    }

    window.nodes.editNode = () => {
      window.canvas.processContextMenu();
    }

    window.nodes.saveNodework = () => {
      fileDialog.files[window.fileDialog.curFileName] =  graph.serialize(); 
		  fileDialog.saveToStorage();
      window.showSnackbar("Saved nodework: " + window.fileDialog.curFileName)
    }

    window.nodes.upload = () => {
      saveMap();
      window.showSnackbar("nodework sent to nodi.box!")
    }

    import { LGraph } from "./litegraph.js"
    import FileDialog from './filedialog.js';
    import NodeDialog from './nodedialog.js';
    localStorage.version = "0.1"
    window.graph = new LGraph();
    window.canvas = new LGraphCanvas("#mycanvas", graph);
    window.fileDialog = new FileDialog(localStorage);

    window.canvas.current_node_cbs.push(() => { 
        if (window.canvas.current_node) {
          console.log("disable")
        }
        else {
          console.log("enable")
        }
      }
    )
/*



	document.getElementById("saveAsButton").onclick = () => {
		let newFileName = fileDialog.rename(window.fileDialog.curFileName, false);
		fileDialog.files[newFileName] =  graph.serialize(); 
		window.fileDialog.curFileName = newFileName;
		Toastify({text: "Saved nodework: " + window.fileDialog.curFileName, gravity: "bottom"}).showToast();
	}


	document.getElementById("loadButton").onclick = () => {
		fileDialog.onFileSelected = filename => {;
			graph.configure(fileDialog.files[window.fileDialog.curFileName])
			graph.start()
			Toastify({text: "Loaded nodework: " + window.fileDialog.curFileName, gravity: "bottom"}).showToast();
		};

		fileDialog.open();
	}

*/

	graph.configure(fileDialog.files[window.fileDialog.curFileName])
	graph.start()
	canvas.showSearchBox();

	window.addEventListener('resize', function () { canvas.resize() })

	import "./nodes/data/bit.js"
	import "./nodes/data/number.js"
	import "./nodes/math/add.js"
	import "./nodes/math/isequal.js"
	import "./nodes/math/islower.js"
	import "./nodes/math/counter.js"
	import "./nodes/control/junction.js"
	import "./nodes/control/router.js"
	import "./nodes/control/selector.js"
	import "./nodes/logic/and.js"
	import "./nodes/logic/or.js"
	import "./nodes/logic/not.js"
	import "./nodes/time/interval.js"
	import "./nodes/widget/button.js"
	import "./nodes/widget/toggle.js"
	import "./nodes/nodi.box/b1.js"
	import "./nodes/nodi.box/b2.js"
	import "./nodes/nodi.box/b3.js"
	import "./nodes/nodi.box/b4.js"
	import "./nodes/nodi.box/yellow.js"
	import "./nodes/nodi.box/red.js"
	import "./nodes/nodi.box/stepper.js"


	let nodeList = {}
	for(let nodeClassName in LiteGraph.registered_node_types) {
		let nodeClass = LiteGraph.registered_node_types[nodeClassName]
		if (nodeList[nodeClass.category] == null) nodeList[nodeClass.category] = []
		nodeList[nodeClass.category].push(nodeClass.elementName)
	}

	window.nodeDialog = new NodeDialog(nodeList);


  window.nodeDialog.onNodeSelected = (nodeName) => {
    window.graph.beforeChange();
    var node = LiteGraph.createNode(nodeName);
    if (node) {
      node.setPos((window.canvas.visible_area[0] + window.canvas.visible_area[2]) / 2,
            (window.canvas.visible_area[1] + window.canvas.visible_area[3]) / 2);
            window.graph.add(node, false);
    }

    window.graph.afterChange();
  }

  </script>

<script type="text/babel">
  const { Button, FormControl , InputLabel , Select , MenuItem , colors,EditIcon, styled, Dialog , List, Modal,
    DialogTitle , DialogContent , Paper, Grid , DialogContentText , DialogActions, TextField, 
    CssBaseline, IconButton, ThemeProvider, Typography, Container, ListItem, FormGroup, ListItemText, 
    Fab, Snackbar, FormControlLabel, PropTypes, Slide, Switch, Tab, Tabs, createTheme, ListItemButton, ListItemIcon, 
    Box, SvgIcon, Link} = MaterialUI;

  window.mui = MaterialUI

  // Create a theme instance.
  const theme = createTheme({
    palette: {
      primary: {
        main: '#556cd6',
      },
      secondary: {
        main: '#19857b',
      },
      error: {
        main: colors.red.A400,
      },
    },
  });

  function TabPanel(props) {
    const { children, value, index, ...other } = props;

    return (
      <div
        role="tabpanel"
        hidden={value !== index}
        id={`simple-tabpanel-${index}`}
        aria-labelledby={`simple-tab-${index}`}
        {...other}
      >
        {value === index && (
          <Box sx={{ p: 3 }}>
            {children}
          </Box>
        )}
      </div>
    );
  }

  function FullWidthGrid( {category, setOpen}) {
    return (
      <Box sx={{ flexGrow: 1 }}>
        <Grid container spacing={2}>
          {window.nodes.list[category].map(label => (
              <Grid key={label} item >
                  <Button variant="outlined" onClick={ ()=> {window.nodes.addNode(category+"/"+label);setOpen(false);} }>
                    {label}
                  </Button>
              </Grid>
            ))
          }

        </Grid>
      </Box>
    );
  }

  function SelectNodeDialog({ openND, setOpenND }) {
    const handleClose = () => {
      setOpenND(false);
    };


    return (
      <React.Fragment>
        <Dialog
          open={openND}
          onClose={handleClose}
        >
          <DialogTitle>Nodes</DialogTitle>
          <DialogContent>
            <Box
              noValidate
              component="form"
              sx={{
                display: 'flex',
                flexDirection: 'column',
                m: 'auto',
                width: 'fit-content',
              }}
            >

            <BasicTabs setOpen = {setOpenND} />

            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={handleClose}>Close</Button>
          </DialogActions>
        </Dialog>
      </React.Fragment>
    );
  }

  const style = {
    position: 'absolute',
    top: '50%',
    left: '50%',
    transform: 'translate(-50%, -50%)',
    width: 400,
    bgcolor: 'background.paper',
    border: '2px solid #000',
    boxShadow: 24,
    pt: 2,
    px: 4,
    pb: 3,
  };


  function RenameDialog({visible, show, filename, saveAs}) {
    const [newFilename, setNewFilename] = React.useState("");
    const textRef = React.useRef(null);

    const handleClose = () => {
      console.log("SAVEAS"+saveAs)
      show(false);
    };

    const handleRename = () => {
      var currentFiles = JSON.parse(localStorage.files)
      currentFiles[textRef.current.value] = currentFiles[filename]
      delete currentFiles[filename]
      localStorage.files = JSON.stringify(currentFiles)
      show(false);
    };

    const handleSaveAs= () => {
      var currentFiles = JSON.parse(localStorage.files)
      currentFiles[textRef.current.value] = currentFiles[filename]
      localStorage.files = JSON.stringify(currentFiles)
      show(false);
    };

    return (
      <React.Fragment>
        <Modal
          open={visible}
          onClose={handleClose}
          aria-labelledby="child-modal-title"
          aria-describedby="child-modal-description"
        >
          <Box sx={{ ...style, width: 200 }}>
            <TextField
              id="outlined-helperText"
              label="New file name"
              defaultValue = {filename}
              inputRef = {textRef}
            />
            {saveAs ? <Button onClick={handleSaveAs}>Save As</Button> : <Button onClick={handleRename}>Rename</Button>}
            <Button onClick={handleClose}>Cancel</Button>
            
          </Box>
        </Modal>
      </React.Fragment>
    );
  }
  function SelectFileDialog({ openND, setOpenND }) {
    const [renameDialogVisible, showRenameDialog] = React.useState(false);
    const [filename, setFilename] = React.useState("");

    const handleRename = (newFileName) => {
      setFilename(newFileName);
      showRenameDialog(true);
    };


    const handleClose = () => {
      setOpenND(false);
    };

    return (
      <React.Fragment>
        <Dialog  open={openND} onClose={handleClose}>
          <DialogTitle>Files</DialogTitle>
          <DialogContent>
            <Box sx={{ width: '100%', maxWidth: 360, bgcolor: 'background.paper' }}>
            <nav aria-label="main mailbox folders">
              <List>
                {Object.keys(JSON.parse(localStorage.files)).map((label, index) => (
                    <ListItem key={index} disablePadding>
                      <ListItemButton>
                        <ListItemText primary={label} />
                      </ListItemButton>
                      <ListItemButton>
                        <ListItemText primary="Remove" />
                      </ListItemButton>
                      <ListItemButton onClick={ ()=>handleRename(label) }>
                        <ListItemText primary="Rename" />
                      </ListItemButton>
                    </ListItem>
                ))}
              </List>
            </nav>
          </Box>
          <RenameDialog visible = {renameDialogVisible} show = {showRenameDialog} filename = {filename} saveAs = {false}/>
          </DialogContent>
          <DialogActions>
            <Button onClick={handleClose}>Close</Button>
          </DialogActions>
        </Dialog>
      </React.Fragment>
    );
  }
  function a11yProps(index) {
    return {
      id: `simple-tab-${index}`,
      'aria-controls': `simple-tabpanel-${index}`,
    };
  }

  function BasicTabs({setOpen}) {
    const [value, setValue] = React.useState(0);

    const handleChange = (event, newValue) => {
      setValue(newValue);
    };

    return (
      <Box sx={{ width: '100%' }}>
        <Box sx={{ borderBottom: 1, borderColor: 'divider' }}>
          <Tabs value={value} onChange={handleChange} aria-label="basic tabs example">
            {Object.keys(window.nodes.list).map((label, index) => (
              <Tab key={index} label={label} {...a11yProps(index)} />
            ))}
          </Tabs>
        </Box>
        {Object.keys(window.nodes.list).map((label, index) => (
          <TabPanel key={index} value={value} index={index}>
            <FullWidthGrid category={label} setOpen = {setOpen}/>
          </TabPanel>
        ))}
      </Box>
    );
  }



  function SimpleSnackbar({openSB, setopenSB, sbMessage}) {

    const handleClick = () => {
      setopenSB(true);
    };

    const handleClose = (event, reason) => {
      if (reason === 'clickaway') {
        return;
      }

      setopenSB(false);
    };

    const action = (
      <React.Fragment>
        <IconButton
          size="small"
          aria-label="close"
          color="inherit"
          onClick={handleClose}
        >
        </IconButton>
      </React.Fragment>
    );

    return (
      <div>
        <Snackbar
          open={openSB}
          autoHideDuration={6000}
          onClose={handleClose}
          message={sbMessage}
          action={action}
        />
      </div>
    );
  }


  function FloatingActionButtons({ showFiles, showNodes, showSaveAsFiles }) {
    const [inputText,setInputText] = React.useState("")

    return (
      <Box sx={{
              display: "flex",
              flexDirection: 'column',
              position: "fixed",
              left: (theme) => theme.spacing(2),
              height: "100%", top: "0", justifyContent: "center",
              gap: 2,
              m: 0.5,
            }}>
        <Fab color="primary"    variant="extended" aria-label="add"     onClick={showNodes}                      > ADD </Fab>
        <Fab color="secondary"  variant="extended" aria-label="remove"  onClick={() => {window.nodes.remNode()}} > Remove </Fab>
        <Fab  color="warning"   variant="extended"                      onClick={() => {window.nodes.editNode()}} >Edit</Fab>
        <Fab color="info"    variant="extended"                         onClick={showFiles} >Load</Fab>
        <Fab  color="success"    variant="extended"                      onClick={() => {window.nodes.saveNodework()}} >Save</Fab>
        <Fab color="info"    variant="extended"                         onClick={showSaveAsFiles} >Save As</Fab>
        <Fab  color="error"    variant="extended"                      onClick={() => {window.nodes.upload()}} >Upload</Fab>
      </Box>
    );
  }



  function App() {
    const [snackbarOpen, setSnackbarOpen] = React.useState(false);
    const [showNodes, setShowNodes] = React.useState(false);
    const [showFiles, setShowFiles] = React.useState(false);
    const [showSaveAsFiles, setShowSaveAsFiles] = React.useState(false);
    const [filename, setFilename] = React.useState("");

    window.showSnackbar = (msg) => {window.messageText = msg; setSnackbarOpen(true)}
    return (
      <Container maxWidth="sm" >
        <SelectNodeDialog openND={showNodes}  setOpenND={setShowNodes}/>
        <SelectFileDialog openND={showFiles}  setOpenND={setShowFiles}/>
        <SimpleSnackbar openSB={snackbarOpen}  setopenSB={setSnackbarOpen} sbMessage = {window.messageText}/>
        <RenameDialog visible = {showSaveAsFiles} show = {setShowSaveAsFiles} filename = {filename} saveAs = {true}/>

        <Box  sx={{ position: "fixed", left: (theme) => theme.spacing(2), my: 8 }}>
          <FloatingActionButtons showFiles={setShowFiles} showNodes = {setShowNodes} showSaveAsFiles = {setShowSaveAsFiles} />
        </Box>

      </Container>
    );
  }

  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(
    <ThemeProvider theme={theme}>
      <CssBaseline />
      <App />
    </ThemeProvider>,
  );
</script>
</body>
</html>