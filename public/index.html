<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="HandheldFriendly" content="true" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="noditron" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <script src="https://apis.google.com/js/api.js"></script>
    
    <title>noditron</title>
    <style>
      html,
      body {
        margin: 0 !important;
        padding: 0 !important;
        height: 100%;
        width: 100%;
      }

      .lgraphcanvas {
        /*cursor: crosshair;*/
        user-select: none;
        -moz-user-select: none;
        -webkit-user-select: none;
        outline: none;
        font-family: Tahoma, sans-serif;
      }

      .lgraphcanvas * {
        box-sizing: border-box;
      }

      /* Styles for high-DPI screens */
      @media only screen and (-webkit-min-device-pixel-ratio: 2),
        only screen and (min--moz-device-pixel-ratio: 2),
        only screen and (min-resolution: 192dpi),
        only screen and (min-resolution: 2dppx) {
      }
    </style>

  </head>
  <script>

   

    const loadJS = (FILE_URL, async = true, type = "module") => {
      return new Promise((resolve, reject) => {
        try {
          const scriptEle = document.createElement("script");
          scriptEle.type = type;
          scriptEle.async = async;
          scriptEle.src = FILE_URL;

          scriptEle.addEventListener("load", (ev) => {
            resolve({ status: true });
          });

          scriptEle.addEventListener("error", (ev) => {
            reject({
              status: false,
              message: `Failed to load the script ${FILE_URL}`,
            });
          });

          document.body.appendChild(scriptEle);
        } catch (error) {
          reject(error);
        }
      });
    };
  </script>
  <script type="module">
    import NodeWork from "./nodework.mjs";
    window.sendToNodework = (cmd, obj) => NodeWork.cmd(window.currentNodeWork, {cmd: cmd, data: obj});
    
    // why loading the scripts one by one?
    // Because the IoT device can not keep more than 10 TCP connections open
    await loadJS("./socket.io.min.js", false);
    await loadJS("./math.js", false);
    await loadJS("./nodework.mjs", false);
    await loadJS("./node.mjs", false);
    
    // load all nodes
    import { nodeList } from './node_list.js'
    for (const file of nodeList) {
        await loadJS(file, false);
    }
    
    import Node from "./node.mjs";
    import Canvas from "./canvas.js";
    import { NodiEnums } from "./enums.mjs";
    
    // save & load
    localStorage.version = "0.1";
    if (localStorage.files == null) localStorage.files = JSON.stringify({});
    window.time = {tick: 0};
    window.load = (filename) => {
      if (localStorage[filename]) {
        window.rootNode = NodeWork.load();
        window.currentNodeWork = window.rootNode;
      }
      window.showSnackbar("Loaded nodework: " + filename);
    };

    window.saveNodework = () => window.sendToNodework("save", {});
    window.upload = () => {
      if (window.socket) {
        let storeGraph = JSON.parse(JSON.stringify(window.nodeWork.serialize()));
        delete storeGraph.config;
        for (let n in storeGraph.nodes) {
          let node = storeGraph.nodes[n];
        }
        window.sendToNodework("setNodework", storeGraph);
        window.showSnackbar("nodework sent to nodi.box!");
      }
    };
    
    // init
    window.canvas = new Canvas("#mycanvas", window.currentNodeWork);
    window.nodeworkID = window.location.search.slice(1);
    window.toParent = () => {
      window.showParent(false);
      if (window.currentNodeWork.parent != null) {
        window.currentNodeWork = window.currentNodeWork.parent;
        window.showParent(true);
      }
    }
    window.copyNode = () => {
      if (window.canvas.copyNode == null && window.current_node)
      window.canvas.copyNode = window.current_node.nodeID;
    else window.canvas.copyNode = null;
  };
  
  window.updateInputs = (id, changedNodeData) => {
      //if (isNaN(changedNodeData.inpValue) == false) changedNodeData.inpValue = parseInt(changedNodeData.inpValue);
      NodeWork.cmd(window.currentNodeWork, {cmd: "updateInputs", data: {
        nodeID: id,
        properties: changedNodeData,
      }});
    };
    window.update = (id, changedNodeData) => window.sendToNodework("updateNode", {nodeID: id, properties: changedNodeData});
    
    window.showEdit(true);
    
    window.addEventListener("resize", function () {
      canvas.resize();
    });
    
    window.NodeWork = NodeWork; //make the static class available for reactjs
    NodeWork.updateNodeList();
    window.rootNode = {};
    NodeWork.clear(window.rootNode);
    window.currentNodeWork = window.rootNode; //window.NodeWork.addNode(window.rootNode, {type: "basic/country", pos: [0, 0]}); // {}
    
    // start the loop
    setInterval(() => { 
      NodeWork.run(window.rootNode);  
      window.time.tick++;
    }, 100);
    await loadJS("./websocket.js", false);
    </script>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    
    <!--
      <script async defer src="https://apis.google.com/js/api.js" onload="window.gapiLoaded()"></script>
      <script async defer src="https://accounts.google.com/gsi/client" onload="window.gisLoaded()"></script>
      -->
    </body>
    
</html>
